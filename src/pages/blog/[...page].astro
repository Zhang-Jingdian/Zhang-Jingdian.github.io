---
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'
import BaseLayout from '@/layouts/BaseLayout.astro'
import { getCollection } from 'astro:content'
import { SITE_CONFIG } from '@/config'
import BlogCard from '@/components/BlogCard/BlogCard.astro'
import { PaginationButton } from '@/components/Pagination'

export const getStaticPaths = (async ({ paginate }) => {
  // 每页显示的文章数量
  const PAGE_SIZE = 9
  
  // 获取所有博客文章并按日期降序排序
  const posts = (await getCollection('blog')).sort(
    (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
  )

  // 使用 paginate 函数生成分页路由
  return paginate(posts, { pageSize: PAGE_SIZE })
}) satisfies GetStaticPaths

type Props = {
  page: Page<CollectionEntry<'blog'>>
}

const { page } = Astro.props

// 获取所有唯一标签
const allPosts = await getCollection('blog')
const allTags = [...new Set(allPosts.flatMap((post) => post.data.tags))]

// 生成页码数组
const pageNumbers = Array.from({ length: page.lastPage }, (_, i) => i + 1)
const visiblePages = pageNumbers.filter((pageNum) => {
  return (
    pageNum === 1 ||
    pageNum === page.lastPage ||
    Math.abs(pageNum - page.currentPage) <= 2
  )
})
---

<BaseLayout
  title={page.currentPage === 1 ? `博客` : `博客 - 第 ${page.currentPage} 页`}
  description="浏览所有博客文章"
>
  <div class="mx-auto max-w-6xl px-4 py-12">
    <!-- 页面标题 -->
    <div class="mb-12">
      <h1 class="mb-4 text-4xl font-bold tracking-tight text-neutral-900">博客文章</h1>
      <p class="text-lg text-neutral-600">
        共 {page.total} 篇文章
        {page.lastPage > 1 && <span class="text-neutral-400">· 第 {page.currentPage} / {page.lastPage} 页</span>}
      </p>
    </div>

    <!-- 标签过滤 -->
    {
      allTags.length > 0 && (
        <div class="mb-8">
          <h2 class="mb-4 text-sm font-semibold uppercase tracking-wide text-neutral-700">标签</h2>
          <div class="flex flex-wrap gap-2">
            {allTags.map((tag) => (
              <a
                href={`/blog/tag/${tag}`}
                class="rounded-full border border-neutral-200 px-3 py-1 text-sm text-neutral-600 transition-colors hover:border-neutral-900 hover:text-neutral-900"
              >
                {tag}
              </a>
            ))}
          </div>
        </div>
      )
    }

    <!-- 文章列表 -->
    {
      
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {page.data.map((post) => (
            <BlogCard post={post} />
          ))}
        </div>
      
    }

    <!-- 分页导航 -->
    {
      page.lastPage > 1 && (
        <nav class="mt-12 flex items-center justify-center gap-2" aria-label="分页导航">
          {/* 上一页 */}
          <PaginationButton
            href={page.url.prev}
            disabled={!page.url.prev}
            client:load
          >
            ← 上一页
          </PaginationButton>

          {/* 页码 */}
          <div class="flex gap-1">
            {visiblePages.map((pageNum, index) => {
              const isCurrentPage = pageNum === page.currentPage
              const href = pageNum === 1 ? '/blog' : `/blog/${pageNum}`
              const prevPageNum = index > 0 ? visiblePages[index - 1] : 0
              const showEllipsis = prevPageNum > 0 && pageNum - prevPageNum > 1

              return (
                <>
                  {showEllipsis && (
                    <PaginationButton variant="ghost" disabled client:load>
                      ···
                    </PaginationButton>
                  )}
                  <PaginationButton
                    href={href}
                    variant={isCurrentPage ? 'active' : 'default'}
                    client:load
                  >
                    {pageNum}
                  </PaginationButton>
                </>
              )
            })}
          </div>

          {/* 下一页 */}
          <PaginationButton
            href={page.url.next}
            disabled={!page.url.next}
            client:load
          >
            下一页 →
          </PaginationButton>
        </nav>
      )
    }
  </div>
</BaseLayout>
